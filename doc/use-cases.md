# Сценарии использования


## Установка переменных окружения

[Почитать об этом можно тут](env-vars.md)


## Выдача хелпа

`dp-b -h` или `db-p --help` - выдает хелп, включая описание переменных окружения.

--------------

## Генерация ключа шифрования (только один раз всех пресетов для одной ветки)

`db-p gen-key`

### Шаги:

* Проверяет DBP_KEY_PATH, если её нет - ругается и выходит.
* Если ключ существует - ругается и выходит.
* Если нет - сохраняет ключ по пути, указанному в DBP_KEY_PATH.

### Результат:

В системе лежит ключ шифрования.

### Замечания

Можно выполнять эту команду только один раз.
А потом копировать существующий ключ на разные машины.
Но теоретически, каждая ветка в каждом репозитории может иметь свою ключ шифрования.
Для секюрности, имеет какой-то смысл для новых веток генерить новый ключ.

--------------

## Стянуть все пресеты для заданного репозитория и ветки

`db-p pull-and-update-local [include=name1,name2] [exclude=name3,name4]`

### Шаги:

* Проверяем, что на amazon есть такая директория. Если нет - ругаемся и выходим.
* Создается (если не было) папка `/opt/db-presets/<repo>/<branch>`
* Создается (если не было) папка `/opt/db-presets-data/<repo>/<branch>`
* Останавливается приложение (AUT).
* В папку стягиваются все (с учетом include/exclude) зашифрованные файлы xz из amazon,
  которые не существуют в папке, или изменились.
* Эти новые или изменившиеся файлы расшифровываются.
* Раз-zx-уются.
* И дальше в цикле по всем пресетам накатываются (`psql -h 127.0.0.1 -U postgres -f name`),
накатываются миграции, сохраняются в db-presets-data с помощью pg_basebackup.
* Останавливается PostgreSQL.

### Результат:

В тестовой системе мы имеем остановленное приложение, остановленный PostgreSQL.
И все снапшоты PG data директорий, с накаченными миграциями.

### Замечания:

Нужно делать перед каждым запуском. Т.к. пресеты кто-то мог поменять. Эти изменения должны подхватиться.

--------------

## Добавление пресета на amazon (после создания)

`db-p push-new name=my-preset desc=description`

### Шаги:

* Проверки на аргументы и переменные окружения.
* Проверка, что на amazon s3 нет такого файла. Есть есть - ругнуться и выйти.
* `pg_dumpall -h 127.0.0.1 -U postgres --clean > <tmp директория внутри самого модуля>`
* xz файла (кол-во потоков = кол-ву процессоров, уровень сжатия - максимальный)
* криптование симметричным ключом.
* заливка на amazon S3 + лог изменений.

### Результат:

* Текущее состояние БД сохранено на amazon S3 в виде нового пресета.
* Рядом с объектом появляется текстовый файл с логом изменений, в который занесен description
  (изменения писать в форме: кто: что_за_изменения).

--------------

## Блокировка пресета на запись на amazon S3.

`db-p set-lock name=my-preset who=my-name desc=description`

### Шаги / Результат:

* В метаданные объекта на Amazon S3 заносится инфа, что объект заблочен, автор и причина.

--------------

## Проверка блокировки пресета на запись на amazon S3.

`db-p get-lock name=my-preset`

### Шаги / Результат:

* Выводится инфа, кто когда и зачем заблокировал.

--------------

## Обновление существующего пресета на amazon (после редактирования)

`db-p push-ex name=my-preset desc=description`

### Шаги:

* Проверки на аргументы и переменные окружения.
* Проверка, что на amazon s3 есть такой файл. Есть нет - ругнуться и выйти.
* `pg_dumpall -h 127.0.0.1 -U postgres --clean > <tmp директория внутри самого модуля>`
* xz файла (кол-во потоков = кол-ву процессоров, уровень сжатия - максимальный)
* криптование симметричным ключом.
* заливка на amazon S3 + лог изменений.

### Результат:

* Текущее состояние БД сохранено на amazon S3 в виде текущей версии существующего пресета.
* Предыдущая версия сохранена в amazon S3. И может быть восстановлена, в случае косяков с базой.
* Лог изменений в самом верху содержит описание изменения.

--------------

## Выбор пресета

`db-p select preset-name`

### Что происходит:

* Если PostgreSQL работает, он останавливается.
* Делается rsync нужной директории из `/opt/db-presets/**/*` в DBP_PG_DATA_DIR.
* Запускается PostgreSQL.
* Запускается приложение.

--------------

## Перезалив с другим ключом шифрования ?? (TODO)

--------------



